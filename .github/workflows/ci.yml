name: Nexus CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:

  # ── 1. Lint & type-check ───────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip

      - name: Install lint deps
        run: pip install flake8 mypy pandas-stubs

      - name: Flake8
        run: |
          flake8 src/ \
            --max-line-length=100 \
            --extend-ignore=E203,W503 \
            --exclude=__pycache__

      - name: Mypy
        run: |
          mypy src/api/models.py \
               src/parser/html_parser.py \
            --ignore-missing-imports \
            --no-strict-optional

  # ── 2. Unit tests ─────────────────────────────────────────────────────────
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip

      - name: Install dependencies
        run: |
          pip install \
            fastapi==0.109.0 \
            uvicorn==0.27.0 \
            pydantic==2.5.3 \
            beautifulsoup4==4.12.3 \
            pandas==2.2.0 \
            pyarrow==15.0.0 \
            requests==2.31.0 \
            httpx==0.26.0 \
            pytest==8.0.0 \
            pytest-cov==4.1.0 \
            pytest-asyncio==0.23.3

      - name: Create data directories
        run: mkdir -p data/raw data/processed

      - name: Run tests
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            -v \
            --tb=short

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: coverage.xml
          fail_ci_if_error: false

  # ── 3. Docker build check ─────────────────────────────────────────────────
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.api
          push: false
          tags: nexus-api:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Dashboard image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.dashboard
          push: false
          tags: nexus-dashboard:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── 4. Integration smoke test ─────────────────────────────────────────────
  smoke:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - uses: actions/checkout@v4

      - name: Start services
        run: |
          mkdir -p data/raw data/processed
          docker compose up -d --build
          echo "Waiting for API to be healthy..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8000/health; then
              echo "API is up!"
              break
            fi
            sleep 3
          done

      - name: Health check
        run: |
          curl -sf http://localhost:8000/health | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['status'] == 'healthy', f'Bad status: {data}'
          print(' Health check passed')
          "

      - name: Root endpoint
        run: |
          curl -sf http://localhost:8000/ | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert data['version'] == '3.0.0', f'Wrong version: {data}'
          print(' Root endpoint OK')
          "

      - name: API docs accessible
        run: |
          STATUS=$(curl -o /dev/null -sw "%{http_code}" http://localhost:8000/docs)
          [ "$STATUS" = "200" ] && echo " Docs OK" || (echo "Docs returned $STATUS" && exit 1)

      - name: Print logs on failure
        if: failure()
        run: docker compose logs

      - name: Tear down
        if: always()
        run: docker compose down -v